<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mongoUtils.mapreduce &mdash; mongoUtils 0.2.2 documentation</title>
    
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.2.2',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="mongoUtils 0.2.2 documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9">

  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">mongoUtils 0.2.2 documentation</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mongoUtils.mapreduce</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;map reduce operations</span>
<span class="sd">notes:map reduce slow with sort see: https://jira.mongodb.org/browse/SERVER-16544 (solved in version 3.0)</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">bson.code</span> <span class="kn">import</span> <span class="n">Code</span>
<span class="kn">from</span> <span class="nn">bson</span> <span class="kn">import</span> <span class="n">SON</span>

<span class="kn">from</span> <span class="nn">Hellas.Thiva</span> <span class="kn">import</span> <span class="n">format_header</span>
<span class="kn">from</span> <span class="nn">mongoUtils.helpers</span> <span class="kn">import</span> <span class="n">parse_js_default</span>
<span class="kn">from</span> <span class="nn">mongoUtils.helpers</span> <span class="kn">import</span> <span class="n">coll_index_names</span>


<div class="viewcode-block" id="mr"><a class="viewcode-back" href="../../mongoUtils.html#mongoUtils.mapreduce.mr">[docs]</a><span class="k">def</span> <span class="nf">mr</span><span class="p">(</span>
    <span class="n">coll</span><span class="p">,</span>                       <span class="c"># a pymongo collection instance</span>
    <span class="n">fun_map</span><span class="p">,</span>                    <span class="c"># js function used for map</span>
    <span class="n">fun_reduce</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>            <span class="c"># js function used for reduce defaults to one counting values</span>
    <span class="n">query</span><span class="o">=</span><span class="p">{},</span>                   <span class="c"># a pymongo query dictionary to query coll defaults to {}</span>
    <span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;replace&quot;</span><span class="p">:</span> <span class="s">&#39;mr_tmp&#39;</span><span class="p">},</span>  <span class="c"># output dict {&#39;replace&#39;|&#39;merge&#39;|&#39;reduce&#39;|&#39;inline&#39;:collection_name|&#39;database&#39;:db_name}</span>
    <span class="n">fun_finalize</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>          <span class="c"># js function to run on finalize</span>
    <span class="n">scope</span><span class="o">=</span><span class="p">{},</span>                   <span class="c"># vars available during map-reduce-finalize</span>
    <span class="n">sort</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>                  <span class="c"># i.e: sort= { &quot;_id&quot;:1 } short dict to sort before map</span>
    <span class="n">jsMode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>               <span class="c"># True|False (don&#39;t convert to Bson between map &amp; reduce if True)</span>
    <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span>                   <span class="c"># if 1 includes timing info on output if 2,3  more details</span>
        <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;simplified generic Map Reduce</span>
<span class="sd">    see: http://docs.mongodb.org/manual/reference/command/mapReduce/</span>
<span class="sd">    * when output is {&#39;inline&#39;:1} MAX output size is 16MB (Max BOSON doc size)</span>
<span class="sd">    * if map reduce is on a replica secondary only output option is &#39;inline&#39;</span>

<span class="sd">    :Args:</span>

<span class="sd">      - coll (object) a pymongo collection instance</span>
<span class="sd">      - fun_map js function used for map</span>
<span class="sd">      - fun_reduce js function used for reduce defaults to a function that increments value count</span>
<span class="sd">      - query a pymongo query dictionary to query collection, defaults to {}</span>
<span class="sd">      - out  a dictionary for output specification  {&#39;replace&#39;|&#39;merge&#39;|&#39;reduce&#39;|&#39;inline&#39;:collection_name|&#39;db:db_name}</span>
<span class="sd">        defaults to {&quot;replace&quot;: &#39;mr_tmp&#39;}</span>
<span class="sd">      - scope vars available during map-reduce-finalize</span>
<span class="sd">      - sort dictionary to sort before map  i.e: sort= { &quot;_id&quot;:1 }</span>
<span class="sd">      - jsMode True|False (don&#39;t convert to Bson between map &amp; reduce if True)</span>
<span class="sd">        should be False if we expect more than 500K distinct results</span>
<span class="sd">      - db&#39; (optional): database_name</span>
<span class="sd">        if no db is specified output collection will be in same db as input coll</span>

<span class="sd">    :Returns: tuple (results collection or results list if out={&quot;inline&quot;:1}, MR response object)</span>

<span class="sd">    :Notes:</span>

<span class="sd">    optimize by sorting on emit field</span>
<span class="sd">        see: http://edgystuff.tumblr.com/post/7624019777/optimizing-map-reduce-with-mongodb</span>
<span class="sd">        but also see my ticket on:https://jira.mongodb.org/browse/SERVER-16544</span>
<span class="sd">        docs.mongodb.org/manual/reference/method/db.coll.mapReduce/#db.coll.mapReduce</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">def</span> <span class="nf">mr_cmd</span><span class="p">():</span>
        <span class="sd">&#39;&#39;&#39;returns the actual command from output parameter&#39;&#39;&#39;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="s">&#39;replace&#39;</span><span class="p">,</span> <span class="s">&#39;merge&#39;</span><span class="p">,</span> <span class="s">&#39;reduce&#39;</span><span class="p">,</span> <span class="s">&#39;inline&#39;</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">())][</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">mr_cmd</span><span class="p">()</span>
        <span class="c"># print (&quot;command&quot;, command)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">SON</span><span class="p">([(</span><span class="n">command</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="n">command</span><span class="p">]),</span> <span class="p">(</span><span class="s">&#39;db&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;db&#39;</span><span class="p">)),</span>
                   <span class="p">(</span><span class="s">&#39;nonAtomic&#39;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;nonAtomic&#39;</span><span class="p">,</span> <span class="bp">False</span><span class="p">))])</span>
        <span class="c"># nonAtomic not allowed on replace</span>
    <span class="n">fun_map</span> <span class="o">=</span> <span class="n">Code</span><span class="p">(</span><span class="n">fun_map</span><span class="p">,</span> <span class="p">{})</span>
    <span class="k">if</span> <span class="n">fun_reduce</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">fun_reduce</span> <span class="o">=</span> <span class="n">parse_js_default</span><span class="p">(</span><span class="s">&#39;MapReduce.js&#39;</span><span class="p">,</span> <span class="s">&#39;GroupCountsReduce&#39;</span><span class="p">)</span>
    <span class="n">fun_reduce</span> <span class="o">=</span> <span class="n">Code</span><span class="p">(</span><span class="n">fun_reduce</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
        <span class="n">sort</span> <span class="o">=</span> <span class="n">SON</span><span class="p">(</span><span class="n">sort</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s">&quot;Map Reduce {}</span><span class="se">\n\</span>
<span class="s">                collection={coll!s:}</span><span class="se">\n\</span>
<span class="s">                query=     {query!s:}</span><span class="se">\n\</span>
<span class="s">                sort=      {sort!s:}</span><span class="se">\n\</span>
<span class="s">                scope=     {scope!s}</span><span class="se">\n\</span>
<span class="s">                out=       {out!s:}</span><span class="se">\n\</span>
<span class="s">                jsMode=    {jsMode!s:}</span><span class="se">\n\</span>
<span class="s">                map=       {fun_map!s:}</span><span class="se">\n\</span>
<span class="s">                reduce=    {fun_reduce!s:}</span><span class="se">\n\</span>
<span class="s">                finalize=  {fun_finalize!s:}</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="n">frmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;Starting...&#39;</span><span class="p">,</span> <span class="o">**</span><span class="nb">locals</span><span class="p">()))</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">map_reduce</span><span class="p">(</span><span class="n">fun_map</span><span class="p">,</span> <span class="n">fun_reduce</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
                        <span class="n">finalize</span><span class="o">=</span><span class="n">fun_finalize</span><span class="p">,</span> <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span>
                        <span class="n">full_response</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">jsMode</span><span class="o">=</span><span class="n">jsMode</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s">&quot;Map Reduce {}</span><span class="se">\n\</span>
<span class="s">                ok=        {ok:}</span><span class="se">\n\</span>
<span class="s">                millisecs = {timeMillis:,d}</span><span class="se">\n\</span>
<span class="s">                counts=    {counts!s:}</span><span class="se">\n\</span>
<span class="s">                out=       {!s:}</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">print</span><span class="p">(</span><span class="n">frmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s">&#39;End&#39;</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="o">**</span><span class="n">r</span><span class="p">))</span>
    <span class="k">if</span> <span class="s">&#39;db&#39;</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="c"># @note:  can be dict or SON, either way it has property keys</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="o">.</span><span class="n">connection</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">][</span><span class="s">&#39;db&#39;</span><span class="p">]][</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">][</span><span class="s">&#39;coll&#39;</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">r</span><span class="p">[</span><span class="s">&#39;results&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">keys</span><span class="p">())[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;inline&#39;</span> <span class="k">else</span> <span class="n">coll</span><span class="o">.</span><span class="n">database</span><span class="p">[</span><span class="n">r</span><span class="p">[</span><span class="s">&#39;result&#39;</span><span class="p">]]</span>
        <span class="c"># @note:  results is a list if inline else a coll</span>
    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">r</span>

</div>
<div class="viewcode-block" id="group_counts"><a class="viewcode-back" href="../../mongoUtils.html#mongoUtils.mapreduce.group_counts">[docs]</a><span class="k">def</span> <span class="nf">group_counts</span><span class="p">(</span>
        <span class="n">collection</span><span class="p">,</span>
        <span class="n">field_name</span><span class="o">=</span><span class="s">&quot;_id&quot;</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="p">{},</span>
        <span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;replace&quot;</span><span class="p">:</span> <span class="s">&#39;mr_tmp&#39;</span><span class="p">},</span>
        <span class="n">sort</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">jsMode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;group values of field using map reduce (see: &#39;mr&#39;)</span>

<span class="sd">    :Examples:</span>

<span class="sd">    - r,col=mr_group(a_collection, &#39;lang&#39;, out={&quot;replace&quot;: &quot;del_1&quot;}, verbose=3)</span>
<span class="sd">    - r,col=mr_group(a_collection, &#39;lang&#39;, out={&quot;replace&quot;: &quot;del_1&quot;, &#39;db&#39;:&#39;local&#39;})</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">FunMap</span> <span class="o">=</span> <span class="n">parse_js_default</span><span class="p">(</span><span class="s">&#39;MapReduce.js&#39;</span><span class="p">,</span> <span class="s">&#39;GroupCountsMap&#39;</span><span class="p">,</span> <span class="n">field_name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">mr</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span> <span class="n">FunMap</span><span class="p">,</span> <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span> <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="n">sort</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span> <span class="n">jsMode</span><span class="o">=</span><span class="n">jsMode</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="mr2"><a class="viewcode-back" href="../../mongoUtils.html#mongoUtils.mapreduce.mr2">[docs]</a><span class="k">def</span> <span class="nf">mr2</span><span class="p">(</span>
        <span class="n">operation</span><span class="p">,</span>          <span class="c"># one of &#39;Orphans&#39; or &#39;Join&#39;</span>
        <span class="n">col_a</span><span class="p">,</span>
        <span class="n">col_a_key</span><span class="p">,</span>
        <span class="n">col_b</span><span class="p">,</span>
        <span class="n">col_b_key</span><span class="p">,</span>
        <span class="n">col_a_query</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">col_b_query</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">db</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
        <span class="n">sort_on_key_fields</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">jsMode</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;A kind of set operation on 2 collections</span>
<span class="sd">    Map Reduce two collection objects (col_a, col_b) on a common field (col_a_key, col_b_key)</span>
<span class="sd">    allowing queries (col_a_query, col_b_query)</span>

<span class="sd">    :Args:</span>

<span class="sd">    - col_a, col_b  :pymongo collection objects</span>
<span class="sd">    - col_a_key col_b_key: name of fields to run MR for col_a &amp; col_b</span>
<span class="sd">    - col_a_query, col_b_query optional queries to run on respective collections</span>
<span class="sd">    - db optional db name to use for results (use &#39;local&#39; to avoid replication on results)</span>
<span class="sd">    - out: optional output collection name defaults to mr_operation</span>
<span class="sd">    - sort_on_key_fields: (bool) tries to sort on key if key has an index this is supposed to speed up MR</span>
<span class="sd">    - jsMode (True or False) (see mongo documentation)</span>

<span class="sd">    :Returns:</span>

<span class="sd">    a tuple(results_collection collection, MapReduce1 statistics, MapReduce2 statistics)</span>

<span class="sd">    :results_collection:</span>

<span class="sd">    if operation = &#39;Orphans&#39;:</span>
<span class="sd">    {u&#39;_id&#39;: u&#39;105719173&#39;, u&#39;value&#39;: {u&#39;A&#39;: 2.0, u&#39;sum&#39;: 3.0, u&#39;B&#39;: 1.0}}</span>
<span class="sd">    _id = key</span>
<span class="sd">    value.a = count of documents in a,</span>
<span class="sd">    value.b count of documents in b,</span>
<span class="sd">    sum = count of documents in both A+B</span>
<span class="sd">    to get documents non existing in col_a:</span>

<span class="sd">    &gt;&gt;&gt; resultCollection.find({&#39;value.a&#39;:0})</span>

<span class="sd">    to get documents non existing in col_a:</span>

<span class="sd">    &gt;&gt;&gt; resultCollection.find({&#39;value.b&#39;:0})</span>

<span class="sd">    to get documents existing in both col_a and col_b</span>
<span class="sd">    &gt;&gt;&gt; resultCollection.find({&#39;value.a&#39;:{&#39;$gt&#39;:0}, &#39;value.a&#39;:{&#39;$gt&#39;:0}})</span>

<span class="sd">    to check for unique in both collections</span>

<span class="sd">    &gt;&gt;&gt; resultCollection.find({&#39;value.sum&#39;:2})</span>

<span class="sd">    :result_collection:</span>

<span class="sd">    if operation = &#39;Join&#39;:</span>

<span class="sd">    {&#39;_id&#39;: &#39;100001818&#39;, u&#39;value&#39;: {&#39;a&#39;: document from col_a,&#39;b&#39;:document from col_b}}</span>

<span class="sd">    if a document is missing from a collection its value will be None</span>

<span class="sd">    :example:</span>

<span class="sd">    &gt;&gt;&gt; mr2(&quot;Orphans&#39;, bof.TstatusesSrc, &#39;_id&#39;, {}, col_b=ag13, col_b_key=&#39;_id.vl&#39;,</span>
<span class="sd">    col_b_query={&#39;_id.kt&#39;: &#39;src&#39;}, out=&#39;mr_join&#39;, jsMode=False, verbose=3)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">out</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="s">&#39;mr2_&#39;</span> <span class="o">+</span> <span class="n">operation</span>
    <span class="n">map_js</span> <span class="o">=</span> <span class="n">parse_js_default</span><span class="p">(</span><span class="s">&#39;MapReduce.js&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">+</span><span class="s">&#39;Map&#39;</span><span class="p">)</span>
    <span class="n">reduce_js</span> <span class="o">=</span> <span class="n">parse_js_default</span><span class="p">(</span><span class="s">&#39;MapReduce.js&#39;</span><span class="p">,</span> <span class="n">operation</span><span class="o">+</span><span class="s">&#39;Reduce&#39;</span><span class="p">)</span>
    <span class="n">mr_a</span> <span class="o">=</span> <span class="n">mr</span><span class="p">(</span>
        <span class="n">col_a</span><span class="p">,</span>
        <span class="n">map_js</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_a_key</span><span class="p">),</span>
        <span class="n">fun_reduce</span><span class="o">=</span><span class="n">reduce_js</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">col_a_query</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;db&#39;</span><span class="p">:</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;replace&#39;</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">db</span> <span class="k">else</span> <span class="p">{</span><span class="s">&#39;replace&#39;</span><span class="p">:</span> <span class="n">out</span><span class="p">},</span>
        <span class="n">scope</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;phase&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="n">sort</span><span class="o">=</span><span class="p">{</span><span class="n">col_a_key</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="k">if</span> <span class="n">sort_on_key_fields</span> <span class="ow">and</span> <span class="n">col_a_key</span> <span class="ow">in</span> <span class="n">coll_index_names</span><span class="p">(</span><span class="n">col_a</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">jsMode</span><span class="o">=</span><span class="n">jsMode</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
    <span class="n">mr_b</span> <span class="o">=</span> <span class="n">mr</span><span class="p">(</span>
        <span class="n">col_b</span><span class="p">,</span>
        <span class="n">map_js</span> <span class="o">%</span> <span class="p">(</span><span class="n">col_b_key</span><span class="p">),</span>
        <span class="n">fun_reduce</span><span class="o">=</span><span class="n">reduce_js</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">col_b_query</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;db&#39;</span><span class="p">:</span> <span class="n">db</span><span class="p">,</span> <span class="s">&#39;reduce&#39;</span><span class="p">:</span> <span class="n">out</span><span class="p">}</span> <span class="k">if</span> <span class="n">db</span> <span class="k">else</span> <span class="p">{</span><span class="s">&#39;reduce&#39;</span><span class="p">:</span> <span class="n">out</span><span class="p">},</span>
        <span class="n">scope</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;phase&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
        <span class="n">sort</span><span class="o">=</span><span class="p">{</span><span class="n">col_b_key</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="k">if</span> <span class="n">sort_on_key_fields</span> <span class="ow">and</span> <span class="n">col_b_key</span> <span class="ow">in</span> <span class="n">coll_index_names</span><span class="p">(</span><span class="n">col_b</span><span class="p">)</span> <span class="k">else</span> <span class="bp">None</span><span class="p">,</span>
        <span class="n">jsMode</span><span class="o">=</span><span class="n">jsMode</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span>
        <span class="p">)</span>
    <span class="k">return</span> <span class="n">mr_b</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mr_a</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">mr_b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

</div>
<div class="viewcode-block" id="schema"><a class="viewcode-back" href="../../mongoUtils.html#mongoUtils.mapreduce.schema">[docs]</a><span class="k">def</span> <span class="nf">schema</span><span class="p">(</span><span class="n">collection</span><span class="p">,</span>
           <span class="n">query</span><span class="o">=</span><span class="p">{},</span>
           <span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s">&quot;replace&quot;</span><span class="p">:</span> <span class="s">&#39;tmpMrFields&#39;</span><span class="p">},</span>  <span class="c"># does not work with &#39;inline&#39;</span>
           <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
           <span class="n">meta</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
           <span class="n">scope</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;parms&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s">&#39;levelMax&#39;</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&#39;inclHeaderKeys&#39;</span><span class="p">:</span> <span class="bp">False</span><span class="p">}}):</span>
    <span class="sd">&#39;&#39;&#39;A kind of Schema Analyzer for mongo collections</span>
<span class="sd">    A utility which finds all field&#39;s names used by documents of a collection</span>
<span class="sd">    xxx.floatApprox xxx.bottom&#39;, xxx.top = an internal mongoDB field for storing long integers</span>
<span class="sd">    for a different approach see: https://github.com/variety/variety</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">map_js</span> <span class="o">=</span> <span class="n">parse_js_default</span><span class="p">(</span><span class="s">&#39;MapReduce.js&#39;</span><span class="p">,</span> <span class="s">&#39;KeysMap&#39;</span><span class="p">)</span>
    <span class="n">reduce_js</span> <span class="o">=</span> <span class="n">parse_js_default</span><span class="p">(</span><span class="s">&#39;MapReduce.js&#39;</span><span class="p">,</span> <span class="s">&#39;KeysReduce&#39;</span><span class="p">)</span>
    <span class="n">rt</span> <span class="o">=</span> <span class="n">mr</span><span class="p">(</span>
        <span class="n">collection</span><span class="p">,</span>
        <span class="n">map_js</span><span class="p">,</span>
        <span class="n">reduce_js</span><span class="p">,</span>
        <span class="n">query</span><span class="o">=</span><span class="n">query</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="n">out</span><span class="p">,</span>
        <span class="n">scope</span><span class="o">=</span><span class="n">scope</span><span class="p">,</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">results_col</span><span class="p">,</span> <span class="n">mr_stats</span> <span class="o">=</span> <span class="n">rt</span>
    <span class="n">totalRecords</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">mr_stats</span><span class="p">[</span><span class="s">&#39;counts&#39;</span><span class="p">][</span><span class="s">&#39;input&#39;</span><span class="p">])</span>
    <span class="n">totalCnt</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;calculating percentages ...&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">results_col</span><span class="o">.</span><span class="n">find</span><span class="p">():</span>
        <span class="n">cnt</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;cnt&#39;</span><span class="p">]</span>
        <span class="n">percent</span> <span class="o">=</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">/</span> <span class="n">totalRecords</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">doc</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;percent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">percent</span>
        <span class="n">results_col</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="p">{</span><span class="s">&#39;_id&#39;</span><span class="p">:</span> <span class="n">doc</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]},</span>
            <span class="p">{</span><span class="s">&quot;$set&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s">&quot;value.percent&quot;</span><span class="p">:</span> <span class="n">percent</span><span class="p">}},</span> <span class="n">safe</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">multi</span><span class="o">=</span><span class="bp">False</span>
            <span class="p">)</span>
        <span class="c"># @warning:  don&#39;t use {_id:id} does not work possibly coz different subfields order</span>
        <span class="c"># print results_col.find_one({&#39;_id&#39;:doc[&#39;_id&#39;]}, safe=True)</span>
        <span class="n">totalCnt</span> <span class="o">+=</span> <span class="n">cnt</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">print</span> <span class="p">(</span><span class="s">&quot;creating indexes&quot;</span><span class="p">)</span>
    <span class="n">rt</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ensure_index</span><span class="p">(</span><span class="s">&#39;_id.type&#39;</span><span class="p">,</span> <span class="n">background</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">meta</span><span class="p">:</span>
        <span class="n">rtMeta</span> <span class="o">=</span> <span class="n">schema_meta</span><span class="p">(</span><span class="n">rt</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rt</span><span class="p">,</span> <span class="n">rtMeta</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rt</span>

</div>
<div class="viewcode-block" id="schema_meta"><a class="viewcode-back" href="../../mongoUtils.html#mongoUtils.mapreduce.schema_meta">[docs]</a><span class="k">def</span> <span class="nf">schema_meta</span><span class="p">(</span><span class="n">mr_keys_results</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;given the results returned by schema calculates and returns statistics for</span>
<span class="sd">    schema fields also pretty prints stats if verbose &gt; 0</span>
<span class="sd">    Be aware of hidden mongoDB fields that mongoDB uses internally</span>

<span class="sd">    :Args:</span>

<span class="sd">    - mr_keys_results: results tuples returned be schema</span>
<span class="sd">    - verbose 0 | 1</span>


<span class="sd">    :Returns:</span>

<span class="sd">    list of statistics for each field</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">map_js</span> <span class="o">=</span> <span class="n">parse_js_default</span><span class="p">(</span><span class="s">&#39;MapReduce.js&#39;</span><span class="p">,</span> <span class="s">&#39;KeysMetaMap&#39;</span><span class="p">)</span>
    <span class="n">reduce_js</span> <span class="o">=</span> <span class="n">parse_js_default</span><span class="p">(</span><span class="s">&#39;MapReduce.js&#39;</span><span class="p">,</span> <span class="s">&#39;KeysMetaReduce&#39;</span><span class="p">)</span>
    <span class="n">hidden_fields</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;floatApprox&#39;</span><span class="p">,</span> <span class="s">&#39;top&#39;</span><span class="p">,</span> <span class="s">&#39;bottom&#39;</span><span class="p">]</span>    <span class="c"># internal mongo fields</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">mr</span><span class="p">(</span>
        <span class="n">mr_keys_results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
        <span class="n">map_js</span><span class="p">,</span>
        <span class="n">reduce_js</span><span class="p">,</span>
        <span class="n">out</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;inline&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">},</span>
        <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
    <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;cnt&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;cnt&#39;</span><span class="p">])</span>
        <span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;depth&#39;</span><span class="p">])</span>
        <span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;notes&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;field&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;depth&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">hidden_fields</span> <span class="ow">or</span> <span class="n">i</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s">&#39;_id.str&#39;</span><span class="p">:</span>
                <span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;notes&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="s">&quot;-hidden mongo field&quot;</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;depth&#39;</span><span class="p">])</span>
    <span class="n">info</span><span class="p">[</span><span class="s">&#39;max depth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">l</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="s">&#39;value&#39;</span><span class="p">][</span><span class="s">&#39;depth&#39;</span><span class="p">]</span>
    <span class="n">info</span><span class="p">[</span><span class="s">&#39;total fields&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s">&#39;_id&#39;</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">frmt</span> <span class="o">=</span> <span class="s">&quot;|{field:^70s}|{cnt:16,d}|{percent:7.2f}|{depth:5d}|{notes:^30s}|&quot;</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">format_header</span><span class="p">(</span><span class="n">frmt</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">l</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="n">frmt</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">i</span><span class="p">[</span><span class="s">&#39;value&#39;</span><span class="p">]))</span>
        <span class="k">print</span><span class="p">(</span><span class="n">header</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;</span><span class="se">\n</span><span class="s">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">print</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l</span></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2015, nickmilon.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.3</a>
      
    </div>

    

    
  </body>
</html>